{% extends 'library/base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>فهرست کتاب‌ها</h2>
    <a href="{% url 'book_add' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> افزودن کتاب جدید
    </a>
</div>

<div class="card mb-4">
    <div class="card-header">
        جستجو و فیلتر
    </div>
    <div class="card-body">
        <form method="get" action="{% url 'book_list' %}">
            <div class="row g-3">
                <div class="col-md-12">
                    <input type="text" name="q" class="form-control" placeholder="جستجو بر اساس نام کتاب یا نویسنده..." value="{{ search_query }}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">از قیمت:</label>
                    <input type="number" name="min_price" class="form-control" placeholder="مثلا ۱۰۰۰۰۰" value="{{ min_price }}">
                </div>
                <div class="col-md-3">
                    <label class="form-label">تا قیمت:</label>
                    <input type="number" name="max_price" class="form-control" placeholder="مثلا ۵۰۰۰۰۰" value="{{ max_price }}">
                </div>

                <div class="col-md-3">
                    <label class="form-label">از سال انتشار:</label>
                    <input type="number" name="start_year" class="form-control" placeholder="مثلا ۱۹۴۳" value="{{ start_year }}">
                </div>
                 <div class="col-md-3">
                    <label class="form-label">تا سال انتشار:</label>
                    <input type="number" name="end_year" class="form-control" placeholder="مثلا ۲۰۲۵" value="{{ end_year }}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">دسته‌بندی:</label>
                    <select name="category" class="form-select">
                        <option value="">همه دسته‌بندی‌ها</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}" {% if cat.id|stringformat:"s" == category_id %}selected{% endif %}>
                                {{ cat.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">ژانر:</label>
                    <select name="genre" class="form-select">
                        <option value="">همه ژانرها</option>
                        {% for genre in genres %}
                            <option value="{{ genre.id }}" {% if genre.id|stringformat:"s" == genre_id %}selected{% endif %}>
                                {{ genre.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-info">اعمال فیلتر</button>
                <a href="{% url 'book_list' %}" class="btn btn-secondary">حذف فیلترها</a>
            </div>
        </form>
    </div>
</div>

{% if books %}
<form method="post" action="{% url 'delete_filtered' %}" onsubmit="return confirm('آیا از حذف تمام کتاب‌های نمایش داده شده مطمئن هستید؟ این عمل غیرقابل بازگشت است.');">
    {% csrf_token %}
    <input type="hidden" name="q" value="{{ search_query }}">
    <input type="hidden" name="min_price" value="{{ min_price }}">
    <input type="hidden" name="max_price" value="{{ max_price }}">
    <input type="hidden" name="start_year" value="{{ start_year }}">
    <input type="hidden" name="end_year" value="{{ end_year }}">
    <input type="hidden" name="category" value="{{ category_id }}">
    <input type="hidden" name="genre" value="{{ genre_id }}">
    <button type="submit" class="btn btn-danger mb-3">
        <i class="bi bi-trash-fill"></i> حذف تمام نتایج فیلتر شده
    </button>
</form>
{% endif %}

<div class="table-responsive">
    <table class="table table-striped table-bordered text-center align-middle">
        <thead class="table-dark">
            <tr>
                <th>عنوان</th>
                <th>نویسنده</th>
                <th>ژانر(ها)</th>
                <th>سال انتشار</th>
                <th>قیمت (تومان)</th>
                <th>علاقه‌مندی</th>
                <th>افزودن به قفسه</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr>
                <td>{{ book.title }}</td>
                <td>{{ book.author }}</td>
                <td>
                    {% for genre in book.genres.all %}
                        <span class="badge bg-secondary">{{ genre.name }}</span>
                    {% empty %}
                        -
                    {% endfor %}
                </td>
                <td>{{ book.publication_year|default:"-" }}</td>
                <td>{{ book.price|floatformat:0 }}</td>
                <td class="text-center">
                    {% if user.is_authenticated %}
                        <form action="{% url 'toggle_favorite' book.pk %}" method="post" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-link text-decoration-none p-0">
                                {% if book in user.favorite_books.all %}
                                    <i class="bi bi-star-fill text-warning fs-5"></i>
                                {% else %}
                                    <i class="bi bi-star fs-5"></i>
                                {% endif %}
                            </button>
                        </form>
                    {% endif %}
                </td>
                <td>
                    {% if user.is_authenticated and user_shelves %}
                        <form action="{% url 'add_to_shelf' book.pk %}" method="post" class="d-flex">
                            {% csrf_token %}
                            <select name="shelf" class="form-select form-select-sm me-2" style="min-width: 120px;">
                                {% for shelf in user_shelves %}
                                    <option value="{{ shelf.pk }}">{{ shelf.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-outline-primary btn-sm">افزودن</button>
                        </form>
                    {% elif user.is_authenticated %}
                        <small class="text-muted">اول یک قفسه بسازید</small>
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'book_edit' book.pk %}" class="btn btn-sm btn-warning">
                        <i class="bi bi-pencil-square"></i> ویرایش
                    </a>
                    <a href="{% url 'book_delete' book.pk %}" class="btn btn-sm btn-danger">
                        <i class="bi bi-trash"></i> حذف
                    </a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="8" class="text-center py-4">
                    هیچ کتابی یافت نشد.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}